# THIS FILE IS GENERATED WITH 'make generate' - DO NOT EDIT MANUALLY
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: restart-dex-wc-on-secrets-change
  annotations:
    policies.kyverno.io/title: Restart Dex on Secrets Change (Workload Clusters)
    policies.kyverno.io/category: Best Practices
    policies.kyverno.io/severity: low
    policies.kyverno.io/minversion: 1.6.0
    policies.kyverno.io/subject: Deployment, Secret
    policies.kyverno.io/description: >-
      This policy automatically triggers rolling restarts of the dex deployment
      on workload clusters when its configuration secret is updated. This complements
      the Helm checksum mechanism by ensuring dex pods restart when the secret
      changes, regardless of how the update occurred.
spec:
  background: false
  schemaValidation: false
  rules:
    - name: restart-dex-on-config-change
      skipBackgroundRequests: true
      match:
        any:
        - resources:
            kinds:
            - Secret
            names:
            - dex
            operations:
            - UPDATE
      preconditions:
        all:
        - key: "{{ `{{` }}request.object.data{{ `}}` }}"
          operator: NotEquals
          value: "{{ `{{` }}request.oldObject.data{{ `}}` }}"
      mutate:
        targets:
          - apiVersion: apps/v1
            kind: Deployment
            name: dex
            namespace: "{{ `{{` }}request.object.metadata.namespace{{ `}}` }}"
        patchStrategicMerge:
          spec:
            template:
              metadata:
                annotations:
                  kyverno.io/restarted-at: "{{ `{{` }}time_now(){{ `}}` }}"
                  kyverno.io/config-version: "{{ `{{` }}request.object.metadata.resourceVersion{{ `}}` }}"
                  kyverno.io/restart-reason: "config-update"

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    application.giantswarm.io/team: shield
    app.kubernetes.io/component: admission-controller
    app.kubernetes.io/instance: kyverno
    app.kubernetes.io/part-of: kyverno
  name: kyverno:gs-ux:restart-dex-wc-on-secrets-change:admission
rules:
- apiGroups:
  - apps
  resources:
  - deployments
  verbs:
  - get
  - list
  - patch
  - update
- apiGroups:
  - ""
  resources:
  - secrets
  verbs:
  - get
  - list
  - watch

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    application.giantswarm.io/team: shield
    app.kubernetes.io/component: background-controller
    app.kubernetes.io/instance: kyverno
    app.kubernetes.io/part-of: kyverno
  name: kyverno:gs-ux:restart-dex-wc-on-secrets-change:background
rules:
- apiGroups:
  - apps
  resources:
  - deployments
  verbs:
  - get
  - list
  - patch
  - update
- apiGroups:
  - ""
  resources:
  - secrets
  verbs:
  - get
  - list
  - watch

